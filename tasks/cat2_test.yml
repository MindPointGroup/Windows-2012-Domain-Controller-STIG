- name: "MEDIUM | V-1141 | AUDIT | Unencrypted passwords must not be sent to third-party SMB Servers."
  win_command: reg query HKLM\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters /v EnablePlainTextPassword
  register: plain_text_password_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in plain_text_password_audit.stderr and plain_text_password_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1141

- name: "MEDIUM | V-1141 | PATCH | Unencrypted passwords must not be sent to third-party SMB Servers."
  win_regedit: 
      key: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters'
      value: EnablePlainTextPassword
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1141

- name: "MEDIUM | V-1145 | AUDIT | Automatic logons must be disabled."
  win_command: reg query \"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" /v AutoAdminLogon
  register: disable_automatic_logons_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_automatic_logons_audit.stderr and disable_automatic_logons_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1145

- name: "MEDIUM | V-1145 | PATCH | Automatic logons must be disabled."
  win_regedit: 
    key: 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon'
    value: AutoAdminLogon
    data: 0
  tags:
      - cat2
      - medium
      - patch
      - V-1145

- name: "MEDIUM | V-1154 | AUDIT | The Ctrl+Alt+Del security attention sequence for logons will be enabled."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v DisableCAD
  register: disable_CAD_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_CAD_audit.stderr and disable_CAD_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1154

- name: "MEDIUM | V-1154 | PATCH | The Ctrl+Alt+Del security attention sequence for logons will be enabled."
  win_regedit: 
      key: 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System'
      value: DisableCAD
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1154

- name: "MEDIUM | V-1162 | AUDIT | The Windows SMB server will perform SMB packet signing when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanManServer\Parameters /v EnableSecuritySignature
  register: SMB_server_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in SMB_server_packet_signing_audit.stderr and SMB_server_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1162

- name: "MEDIUM | V-1162 | PATCH | The Windows SMB server will perform SMB packet signing when possible."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters'
      value: EnableSecuritySignature
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1162

- name: "MEDIUM | V-1163 | AUDIT | Outgoing secure channel traffic will be encrypted when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters /v SealSecureChannel
  register: encrypt_outgoing_secure_channel_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in encrypt_outgoing_secure_channel_audit.stderr and encrypt_outgoing_secure_channel_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1163

- name: "MEDIUM | V-1163 | PATCH | Outgoing secure channel traffic will be encrypted when possible."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters'
      value: SealSecureChannel
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1163

- name: "MEDIUM | V-1164 | AUDIT | Outgoing secure channel traffic will be signed when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters /v SignSecureChannel
  register: sign_outgoing_secure_channel_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in sign_outgoing_secure_channel_audit.stderr and sign_outgoing_secure_channel_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1164

- name: "MEDIUM | V-1164 | PATCH | Outgoing secure channel traffic will be signed when possible."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters'
      value: SignSecureChannel
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1164

- name: "MEDIUM | V-1166 | AUDIT | The Windows SMB client will be enabled to perform SMB packet signing when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanmanWorkstation\Parameters /v EnableSecuritySignature
  register: SMB_client_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in SMB_client_packet_signing_audit.stderr and SMB_client_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1166

- name: "MEDIUM | V-1166 | PATCH | The Windows SMB client will be enabled to perform SMB packet signing when possible."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Services\LanmanWorkstation\Parameters'
      value: EnableSecuritySignature
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1166

- name: "MEDIUM | V-1171 | AUDIT | Ejection of removable NTFS media is not restricted to Administrators."
  win_command: reg query \"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" /v AllocateDASD
  register: eject_removable_media_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in eject_removable_media_audit.stderr and eject_removable_media_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1171

- name: "MEDIUM | V-1171 | PATCH | Ejection of removable NTFS media is not restricted to Administrators."
  win_regedit: 
      key: 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon'
      value: AllocateDASD
      data: 0
  tags:
      - cat2
      - medium
      - patch
      - V-1171

- name: "MEDIUM | V-3374 | AUDIT | The system must be configured to require a strong session key."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters\ /v RequireStrongKey
  register: strong_sessionkey_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in strong_sessionkey_audit.stderr and strong_sessionkey_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3374

- name: "MEDIUM | V-3374 | PATCH | The system must be configured to require a strong session key."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters\'
      value: RequireStrongKey
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3374

- name: "MEDIUM | V-3376 | AUDIT | The system will be configured to prevent the storage of passwords and credentials"
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v DisableDomainCreds
  register: creds_storage_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in creds_storage_audit.stderr and creds_storage_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3376

- name: "MEDIUM | V-3376 | PATCH | The system will be configured to prevent the storage of passwords and credentials"
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: DisableDomainCreds
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3376

- name: "MEDIUM | V-3377 | AUDIT | The system will be configured to prevent anonymous users from having the same rights as the Everyone group."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v EveryoneIncludesAnonymous
  register: everyone_includes_anon_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in everyone_includes_anon_audit.stderr and everyone_includes_anon_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3377

- name: "MEDIUM | V-3377 | PATCH | The system will be configured to prevent anonymous users from having the same rights as the Everyone group."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: EveryoneIncludesAnonymous
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3377

- name: "MEDIUM | V-3378 | AUDIT | The system will be configured to use the Classic security model."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v ForceGuest
  register: classic_security_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in classic_security_audit.stderr and classic_security_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3378

- name: "MEDIUM | V-3378 | PATCH | The system will be configured to use the Classic security model."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: ForceGuest
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3378

- name: "MEDIUM | V-3381 | AUDIT | The system will be configured to the required LDAP client signing level."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LDAP /v LDAPClientIntegrity
  register: LDAP_client_integrity_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in LDAP_client_integrity_audit.stderr and LDAP_client_integrity_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3381

- name: "MEDIUM | V-3381 | PATCH | The system will be configured to the required LDAP client signing level."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Services\LDAP'
      value: LDAPClientIntegrity
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3381

- name: "MEDIUM | V-3382 | AUDIT | The system will be configured to meet the minimum session security requirement for NTLM SSP based clients."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0 /v NTLMMinClientSec
  register: NTLM_min_client_sec_audit
  check_mode: no
  changed_when: "'0x20080000' not in NTLM_min_client_sec_audit.stdout"
  failed_when: "reg_not_found not in NTLM_min_client_sec_audit.stderr and NTLM_min_client_sec_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3382

#Patch omitted for SCIF
#- name: "MEDIUM | V-3382 | PATCH | The system will be configured to meet the minimum session security requirement for NTLM SSP based clients."
#  win_regedit:
#      key: 'HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0'
#      value: NTLMMinClientSec
#      data: 537395200
#      datatype: dword
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-3382

- name: "MEDIUM | V-3385 | AUDIT | The system must be configured to require case insensitivity for non-Windows subsystems."
  win_command: reg query \"HKLM\System\CurrentControlSet\Control\Session Manager\Kernel\" /v ObCaseInsensitive
  register: case_insensitive_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in case_insensitive_audit.stderr and case_insensitive_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3385

- name: "MEDIUM | V-3385 | PATCH | The system must be configured to require case insensitivity for non-Windows subsystems."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Control\Session Manager\Kernel'
      value: ObCaseInsensitive
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3385

- name: "MEDIUM | V-3449 | AUDIT | Remote Desktop Services will limit users to one remote session."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fSingleSessionPerUser
  register: single_rdp_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in single_rdp_audit.stderr and single_rdp_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3449

- name: "MEDIUM | V-3449 | PATCH | Remote Desktop Services will limit users to one remote session."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fSingleSessionPerUser
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3449

- name: "MEDIUM | V-3453 | AUDIT | Remote Desktop Services will always prompt a client for passwords upon connection."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fPromptForPassword
  register: rdp_password_prompt_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in rdp_password_prompt_audit.stderr and rdp_password_prompt_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3453

- name: "MEDIUM | V-3453 | PATCH | Remote Desktop Services will always prompt a client for passwords upon connection."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fPromptForPassword
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3453

- name: "MEDIUM | V-3454 | AUDIT | Remote Desktop Services will be configured with the client connection encryption set to the required level."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MinEncryptionLevel
  register: min_encrypt_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in min_encrypt_audit.stderr and min_encrypt_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3454

#Patch omitted for SCIF
#- name: "MEDIUM | V-3454 | PATCH | Remote Desktop Services will be configured with the client connection encryption set to the required level."
#  action: win_ping
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-3454

- name: "MEDIUM | V-3455 | AUDIT | Remote Desktop Services will be configured to use session-specific temporary folders."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v PerSessionTempDir
  register: temp_folder_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in temp_folder_audit.stderr and temp_folder_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3455

- name: "MEDIUM | V-3455 | PATCH | Remote Desktop Services will be configured to use session-specific temporary folders."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: PerSessionTempDir
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3455

- name: "MEDIUM | V-3456 | AUDIT | Remote Desktop Services will delete temporary folders when a session is terminated."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v DeleteTempDirsOnExit
  register: delete_temp_folder_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in delete_temp_folder_audit.stderr and delete_temp_folder_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3456

- name: "MEDIUM | V-3456 | PATCH | Remote Desktop Services will delete temporary folders when a session is terminated."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: DeleteTempDirsOnExit
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3456

- name: "MEDIUM | V-3457 | AUDIT | Remote Desktop Services will be configured to set a time limit for disconnected sessions."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MaxDisconnectionTime
  register: max_disconnection_time_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in max_disconnection_time_audit.stderr and max_disconnection_time_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3457

- name: "MEDIUM | V-3457 | PATCH | Remote Desktop Services will be configured to set a time limit for disconnected sessions."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: MaxDisconnectionTime
      data: 0x0000ea60
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3457

- name: "MEDIUM | V-3458 | AUDIT | Remote Desktop Services will be configured to disconnect an idle session after the specified time period."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MaxIdleTime
  register: max_idle_time_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in max_idle_time_audit.stderr and max_idle_time_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3458

- name: "MEDIUM | V-3458 | PATCH | Remote Desktop Services will be configured to disconnect an idle session after the specified time period."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: MaxIdleTime
      data: 0x000dbba0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3458

- name: "MEDIUM | V-3469 | AUDIT | The system will be configured to enable the background refresh of Group Policy."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\system /v DisableBkGndGroupPolicy
  register: background_group_policy_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in background_group_policy_audit.stderr and background_group_policy_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3469

- name: "MEDIUM | V-3469 | PATCH | The system will be configured to enable the background refresh of Group Policy."
  win_regedit: 
      key: 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\system'
      value: DisableBkGndGroupPolicy
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3469

- name: "MEDIUM | V-8322 | AUDIT | Time synchronization must be enabled on the domain controller."
  win_shell: "{{ item }}"
  register: time_sync_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in time_sync_audit.stderr and time_sync_audit.stderr"
  with_items:
      - reg query HKLM\System\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient\ /v Enabled
      - reg query HKLM\System\CurrentControlSet\Services\W32Time\Parameters\ /v Type
  tags:
      - cat2
      - medium
      - audit
      - V-8322

#double check on NT5DS
- name: "MEDIUM | V-8322 | PATCH | Time synchronization must be enabled on the domain controller."
  win_regedit:
      key: "{{ item.key }}"
      value: "{{ item.value }}"
      data: "{{ item.data }}"
      datatype: "{{ item.datatype }}"
  with_items:
      - key: 'HKLM:\System\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient\'
        value: Enabled
        data: 1
        datatype: dword
      - key: 'HKLM:\System\CurrentControlSet\Services\W32Time\Parameters\'
        value: Type
        data: NT5DS
        datatype: string
  tags:
      - cat2
      - medium
      - patch
      - V-8322

- name: "MEDIUM | V-8326 | AUDIT | The directory server supporting (directly or indirectly) system access or resource authorization must run on a machine dedicated to that function."
  win_command: net start
  register: dedicated_supporting_machines_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-8326

#"Import-Module ServerManager ;" added for win08 (may not be necessary for win08r2
#https://technet.microsoft.com/en-us/library/ff476071.aspx
- name: "MEDIUM | V-8326 | AUDIT | The directory server supporting (directly or indirectly) system access or resource authorization must run on a machine dedicated to that function."
  win_shell: Import-Module ServerManager ; Get-WindowsFeature | where-object {$_.Installed -eq $True} | format-list DisplayName
  register: dedicated_supporting_machines2_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-8326

- name: "MEDIUM | V-26575 | AUDIT | The 6to4 IPv6 transition technology will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\TCPIP\v6Transition /v 6to4_State
  register: six_to_four_audit
  check_mode: no
  changed_when: no
  failed_when: "six_to_four_audit.stderr and reg_not_found not in six_to_four_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26575

- name: "MEDIUM | V-26575 | PATCH | The 6to4 IPv6 transition technology will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\TCPIP\v6Transition'
      value: 6to4_State
      data: Disabled
  tags:
      - cat2
      - medium
      - patch
      - V-26575

- name: "MEDIUM | V-26576 | AUDIT | The IP-HTTPS IPv6 transition technology will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\TCPIP\v6Transition\IPHTTPS\IPHTTPSInterface /v IPHTTPS_ClientState
  register: IPv6_transition_audit
  check_mode: no
  changed_when: no
  failed_when: "IPv6_transition_audit.stderr and reg_not_found not in IPv6_transition_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26576

- name: "MEDIUM | V-26576 | PATCH | The IP-HTTPS IPv6 transition technology will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\TCPIP\v6Transition\IPHTTPS\IPHTTPSInterface'
      value: IPHTTPS_ClientState
      data: 3
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-26576

- name: "MEDIUM | V-26577 | AUDIT | The ISATAP IPv6 transition technology will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\TCPIP\v6Transition /v ISATAP_State
  register: ISATAP_audit
  check_mode: no
  changed_when: no
  failed_when: "ISATAP_audit.stderr and reg_not_found not in ISATAP_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26577

- name: "MEDIUM | V-26577 | PATCH | The ISATAP IPv6 transition technology will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\TCPIP\v6Transition'
      value: ISATAP_State
      data: Disabled
  tags:
      - cat2
      - medium
      - patch
      - V-26577

- name: "MEDIUM | V-26578 | AUDIT | The Teredo IPv6 transition technology will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\TCPIP\v6Transition /v Teredo_State
  register: Teredo_audit
  check_mode: no
  changed_when: no
  failed_when: "Teredo_audit.stderr and reg_not_found not in Teredo_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26578

- name: "MEDIUM | V-26578 | PATCH | The Teredo IPv6 transition technology will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\TCPIP\v6Transition'
      value: Teredo_State
      data: Disabled
  tags:
      - cat2
      - medium
      - patch
      - V-26578

- name: "MEDIUM | V-26579 | AUDIT | The Application event log must be configured to a minimum size requirement."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application /v MaxSize
  register: application_log_max_size_audit
  check_mode: no
  changed_when: no
  failed_when: "application_log_max_size_audit.stderr and reg_not_found not in application_log_max_size_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26579

- name: "MEDIUM | V-26579 | PATCH | The Application event log must be configured to a minimum size requirement."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application'
      value: MaxSize
      data: 0x00008000
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-26579

- name: "MEDIUM | V-26580 | AUDIT | The Security event log must be configured to a minimum size requirement."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\Security /v MaxSize
  register: security_log_max_size_audit
  check_mode: no
  changed_when: no
  failed_when: "security_log_max_size_audit.stderr and reg_not_found not in security_log_max_size_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26580

- name: "MEDIUM | V-26580 | PATCH | The Security event log must be configured to a minimum size requirement."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Security'
      value: MaxSize
      data: 0x00030000
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-26580

- name: "MEDIUM | V-26581 | AUDIT | The Setup event log must be configured to a minimum size requirement."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\Setup /v MaxSize
  register: setup_log_max_size_audit
  check_mode: no
  changed_when: no
  failed_when: "setup_log_max_size_audit.stderr and reg_not_found not in setup_log_max_size_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26581

- name: "MEDIUM | V-26581 | PATCH | The Setup event log must be configured to a minimum size requirement."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Setup'
      value: MaxSize
      data: 0x00008000
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-26581

- name: "MEDIUM | V-26582 | AUDIT | The System event log must be configured to a minimum size requirement."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\System /v MaxSize
  register: system_log_max_size_audit
  check_mode: no
  changed_when: no
  failed_when: "system_log_max_size_audit.stderr and reg_not_found not in system_log_max_size_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26582

- name: "MEDIUM | V-26582 | PATCH | The System event log must be configured to a minimum size requirement."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\System'
      value: MaxSize
      data: 0x00008000
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-26582

- name: "MEDIUM | V-33663 | AUDIT | The system must be configured to audit DS Access - Directory Service Access successes."
  win_shell: "AuditPol /get /category:*"
  tags:
      - cat2
      - medium
      - audit
      - V-33663

- name: "MEDIUM | V-33663 | PATCH | The system must be configured to audit DS Access - Directory Service Access successes."
  win_shell: AuditPol /set /subcategory:"Directory Service Access" /success:enable
  tags:
      - cat2
      - medium
      - patch
      - V-33663

- name: "MEDIUM | V-33664 | AUDIT | The system must be configured to audit DS Access - Directory Service Access failures."
  win_shell: "AuditPol /get /category:*"
  register: directory_access_failures_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-33664

- name: "MEDIUM | V-33664 | PATCH | The system must be configured to audit DS Access - Directory Service Access failures."
  win_shell: AuditPol /set /subcategory:"Directory Service Access" /failure:enable
  tags:
      - cat2
      - medium
      - patch
      - V-33664

- name: "MEDIUM | V-33665 | AUDIT | The system must be configured to audit DS Access - Directory Service Changes successes."
  win_shell: "AuditPol /get /category:*"
  register: directory_changes_successes_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-33665

- name: "MEDIUM | V-33665 | PATCH | The system must be configured to audit DS Access - Directory Service Changes successes."
  win_shell: AuditPol /set /subcategory:"Directory Service Changes" /success:enable
  tags:
      - cat2
      - medium
      - patch
      - V-33665

- name: "MEDIUM | V-33666 | AUDIT | The system must be configured to audit DS Access - Directory Service Changes failures."
  win_shell: "AuditPol /get /category:*"
  register: directory_changes_failures_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-33666

- name: "MEDIUM | V-33666 | PATCH | The system must be configured to audit DS Access - Directory Service Changes failures."
  win_shell: AuditPol /set /subcategory:"Directory Service Access" /failure:enable
  tags:
      - cat2
      - medium
      - patch
      - V-33666

- name: "MEDIUM | V-36656 | AUDIT | A screen saver must be enabled on the system."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows\Control Panel\Desktop\" /v ScreenSaveActive
  register: screen_saver_enabled_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in screen_saver_enabled_audit.stderr and screen_saver_enabled_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36656

- name: "MEDIUM | V-36656 | PATCH | A screen saver must be enabled on the system."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\Control Panel\Desktop\'
      value: ScreenSaveActive
      data: 1
      datatype: string
  tags:
      - cat2
      - medium
      - patch
      - V-36656

- name: "MEDIUM | V-36657 | AUDIT | The screen saver must be password protected."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows\Control Panel\Desktop\" /v ScreenSaverIsSecure
  register: screen_saver_secure_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in screen_saver_secure_audit.stderr and screen_saver_secure_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36657

- name: "MEDIUM | V-36657 | PATCH | The screen saver must be password protected."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\Control Panel\Desktop\'
      value: ScreenSaverIsSecure
      data: 1
      datatype: string
  tags:
      - cat2
      - medium
      - patch
      - V-36657

- name: "MEDIUM | V-36667 | AUDIT | The system must be configured to audit Object Access - Removable Storage failures."
  win_shell: "AuditPol /get /category:*"
  register: removable_storage_failures_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-36667

- name: "MEDIUM | V-36667 | PATCH | The system must be configured to audit Object Access - Removable Storage failures."
  win_shell: AuditPol /set /subcategory:"Removable Storage" /failure:enable
  tags:
      - cat2
      - medium
      - patch
      - V-36667

- name: "MEDIUM | V-36668 | AUDIT | The system must be configured to audit Object Access - Removable Storage successes."
  win_shell: "AuditPol /get /category:*"
  register: removable_storage_successes_audit
  check_mode: no
  changed_when: no

  tags:
      - cat2
      - medium
      - audit
      - V-36668

- name: "MEDIUM | V-36668 | PATCH | The system must be configured to audit Object Access - Removable Storage successes."
  win_shell: AuditPol /set /subcategory:"Removable Storage" /success:enable
  tags:
      - cat2
      - medium
      - patch
      - V-36668

- name: "MEDIUM | V-36679 | AUDIT | Early Launch Antimalware, Boot-Start Driver Initialization Policy must be enabled and configured to only Good and Unknown."
  win_command: reg query HKLM\System\CurrentControlSet\Policies\EarlyLaunch\ /v DriverLoadPolicy
  register: early_initialization_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in early_initialization_audit.stderr and early_initialization_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36679

- name: "MEDIUM | V-36679 | PATCH | Early Launch Antimalware, Boot-Start Driver Initialization Policy must be enabled and configured to only Good and Unknown."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Policies\EarlyLaunch\'
      value: DriverLoadPolicy
      data: 1
      datatype: dword
  changed_when: no
  tags:
      - cat2
      - medium
      - patch
      - V-36679

- name: "MEDIUM | V-36680 | AUDIT | Access to the Windows Store must be turned off."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Explorer\ /v NoUseStoreOpenWith
  register: windows_store_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in windows_store_audit.stderr and windows_store_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36680

- name: "MEDIUM | V-36680 | PATCH | Access to the Windows Store must be turned off."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Explorer\'
      value: NoUseStoreOpenWith
      data: 1
      datatype: dword
  changed_when: no
  tags:
      - cat2
      - medium
      - patch
      - V-36680

- name: "MEDIUM | V-36681 | AUDIT | Copying of user input methods to the system account for sign-in must be prevented."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Control Panel\International\" /v BlockUserInputMethodsForSignIn
  register: copy_user_system_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in copy_user_system_audit.stderr and copy_user_system_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36681

- name: "MEDIUM | V-36681 | PATCH | Copying of user input methods to the system account for sign-in must be prevented."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Control Panel\International\'
      value: BlockUserInputMethodsForSignIn
      data: 1
      datatype: dword
  changed_when: no
  tags:
      - cat2
      - medium
      - patch
      - V-36681

- name: "MEDIUM | V-36684 | AUDIT | Local users on domain-joined computers must not be enumerated."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\System\ /v EnumerateLocalUsers
  register: local_domain_joined_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in local_domain_joined_audit.stderr and local_domain_joined_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36684

- name: "MEDIUM | V-36684 | PATCH | Local users on domain-joined computers must not be enumerated."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\System\'
      value: EnumerateLocalUsers
      data: 0
      datatype: dword
  changed_when: no
  tags:
      - cat2
      - medium
      - patch
      - V-36684

- name: "MEDIUM | V-36687 | AUDIT | App notifications on the lock screen must be turned off."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\System\ /v DisableLockScreenAppNotifications
  register: app_notifications_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in app_notifications_audit.stderr and app_notifications_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36687

- name: "MEDIUM | V-36687 | PATCH | App notifications on the lock screen must be turned off."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\System\'
      value: DisableLockScreenAppNotifications
      data: 1
      datatype: dword
  changed_when: no
  tags:
      - cat2
      - medium
      - patch
      - V-36687

- name: "MEDIUM | V-36698 | AUDIT | The use of biometrics must be disabled."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Biometrics\ /v Enabled
  register: biometrics_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in biometrics_audit.stderr and biometrics_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36698

- name: "MEDIUM | V-36698 | PATCH | The use of biometrics must be disabled."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Biometrics\'
      value: Enabled
      data: 0
      datatype: dword
  changed_when: no
  tags:
      - cat2
      - medium
      - patch
      - V-36698

- name: "MEDIUM | V-36700 | AUDIT | The password reveal button must not be displayed."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\CredUI\ /v DisablePasswordReveal
  register: password_reveal_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in password_reveal_audit.stderr and password_reveal_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36700

- name: "MEDIUM | V-36700 | PATCH | The password reveal button must not be displayed."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\CredUI\'
      value: DisablePasswordReveal
      data: 1
      datatype: dword
  changed_when: no
  tags:
      - cat2
      - medium
      - patch
      - V-36700

- name: "MEDIUM | V-36708 | AUDIT | The location feature must be turned off."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\LocationAndSensors\ /v DisableLocation
  register: location_feature_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in location_feature_audit.stderr and location_feature_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36708

- name: "MEDIUM | V-36708 | PATCH | The location feature must be turned off."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\LocationAndSensors\'
      value: DisableLocation
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36708

- name: "MEDIUM | V-36709 | AUDIT | Basic authentication for RSS feeds over HTTP must be turned off."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Internet Explorer\Feeds\" /v AllowBasicAuthInClear
  register: authentication_rss_http_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in authentication_rss_http_audit.stderr and authentication_rss_http_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36709

- name: "MEDIUM | V-36709 | PATCH | Basic authentication for RSS feeds over HTTP must be turned off."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Internet Explorer\Feeds\'
      value: AllowBasicAuthInClear
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36709

- name: "MEDIUM | V-36711 | AUDIT | The Windows Store application must be turned off."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\WindowsStore\ /v RemoveWindowsStore
  register: windows_store_app_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in windows_store_app_audit.stderr and windows_store_app_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36711

- name: "MEDIUM | V-36711 | PATCH | The Windows Store application must be turned off."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\WindowsStore\'
      value: RemoveWindowsStore
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36711

- name: "MEDIUM | V-36713 | AUDIT | The Windows Remote Management (WinRM) client must not allow unencrypted traffic."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\WinRM\Client\ /v AllowUnencryptedTraffic
  register: winrm_unencrypted_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in winrm_unencrypted_audit.stderr and winrm_unencrypted_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36713

- name: "MEDIUM | V-36713 | PATCH | The Windows Remote Management (WinRM) client must not allow unencrypted traffic."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\WinRM\Client\'
      value: AllowUnencryptedTraffic
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36713

- name: "MEDIUM | V-36714 | AUDIT | The Windows Remote Management (WinRM) client must not use Digest authentication."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\WinRM\Client\ /v AllowDigest
  register: winrm_digest_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in winrm_digest_audit.stderr and winrm_digest_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36714

- name: "MEDIUM | V-36714 | PATCH | The Windows Remote Management (WinRM) client must not use Digest authentication."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\WinRM\Client\'
      value: AllowDigest
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36714

- name: "MEDIUM | V-36719 | AUDIT | The Windows Remote Management (WinRM) service must not allow unencrypted traffic."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\WinRM\Service\ /v AllowUnencryptedTraffic
  register: winrm_unencrypted_traffic_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in winrm_unencrypted_traffic_audit.stderr and winrm_unencrypted_traffic_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36719

- name: "MEDIUM | V-36719 | PATCH | The Windows Remote Management (WinRM) service must not allow unencrypted traffic."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\WinRM\Service\'
      value: AllowUnencryptedTraffic
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36719

- name: "MEDIUM | V-36720 | AUDIT | The Windows Remote Management (WinRM) service must not store RunAs credentials."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\WinRM\Service\ /v DisableRunAs
  register: winrm_store_runas_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in winrm_store_runas_audit.stderr and winrm_store_runas_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36720

- name: "MEDIUM | V-36720 | PATCH | The Windows Remote Management (WinRM) service must not store RunAs credentials."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\WinRM\Service\'
      value: DisableRunAs
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36720

- name: "MEDIUM | V-36722 | AUDIT | Permissions for the Application event log must prevent access by nonprivileged accounts."
  win_shell: Get-Acl -PATH 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\Application.evtx' | Format-List
  register: eventlog_permissions_audit
  check_mode: no
  changed_when: no
  ignore_errors: yes
  tags:
      - cat2
      - medium
      - audit
      - V-36722

#requires patched win_acl module
- name: "MEDIUM | V-36722 | PATCH | Permissions for the Application event log must prevent access by nonprivileged accounts."
  win_acl:
     path: 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\Application.evtx'
     user: '{{ item }}'
     rights: 'FullControl'
     type: 'allow'
     state: 'present'
     inherit: 'ContainerInherit, ObjectInherit'
     propagation: 'None'
  with_items:
      - 'NT SERVICE\Eventlog'
      - 'NT AUTHORITY\SYSTEM'
      - 'BUILTIN\Administrators'
  tags:
      - cat2
      - medium
      - patch
      - V-36722

- name: "MEDIUM | V-36723 | AUDIT | Permissions for the Security event log must prevent access by nonprivileged accounts."
  win_shell: Get-Acl -PATH 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\Security.evtx' | Format-List
  register: security_evtx_audit
  check_mode: no
  changed_when: no
  ignore_errors: yes
  tags:
      - cat2
      - medium
      - audit
      - V-36723

#requires patched win_acl module
- name: "MEDIUM | V-36723 | PATCH | Permissions for the Security event log must prevent access by nonprivileged accounts."
  win_acl:
     path: 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\Security.evtx'
     user: '{{ item }}'
     rights: 'FullControl'
     type: 'allow'
     state: 'present'
     inherit: 'ContainerInherit, ObjectInherit'
     propagation: 'None'
  with_items:
      - 'NT SERVICE\Eventlog'
      - 'NT AUTHORITY\SYSTEM'
      - 'BUILTIN\Administrators'
  tags:
      - cat2
      - medium
      - patch
      - V-36723

- name: "MEDIUM | V-36724 | AUDIT | Permissions for the System event log must prevent access by nonprivileged accounts."
  win_shell: Get-Acl -PATH 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\System.evtx' | Format-List
  register: result
  check_mode: no
  changed_when: no
  ignore_errors: yes
  tags:
      - cat2
      - medium
      - audit
      - V-36724

#requires patched win_acl module
- name: "MEDIUM | V-36724 | PATCH | Permissions for the System event log must prevent access by nonprivileged accounts."
  win_acl:
     path: 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\System.evtx'
     user: '{{ item }}'
     rights: 'FullControl'
     type: 'allow'
     state: 'present'
     inherit: 'ContainerInherit, ObjectInherit'
     propagation: 'None'
  with_items:
      - 'NT SERVICE\Eventlog'
      - 'NT AUTHORITY\SYSTEM'
      - 'BUILTIN\Administrators'
  tags:
      - cat2
      - medium
      - patch
      - V-36724

- name: "MEDIUM | V-36773 | AUDIT | The machine inactivity limit must be set to 15 minutes, locking the system with the screensaver."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System\ /v InactivityTimeoutSecs
  register: inactivity_limit_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in inactivity_limit_audit.stderr and inactivity_limit_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36773

- name: "MEDIUM | V-36773 | PATCH | The machine inactivity limit must be set to 15 minutes, locking the system with the screensaver."
  win_regedit:
     key: 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System\'
     value: InactivityTimeout
     data: 0x00000384
     datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36773

- name: "MEDIUM | V-40177 | AUDIT | Permissions for program file directories must conform to minimum requirements."
  win_shell: (Get-Acl -PATH '\Program Files').Access.IdentityReference.Value
  register: program_files_minimum_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-40177

- name: "MEDIUM | V-40177 | AUDIT | Permissions for program file directories must conform to minimum requirements."
  win_shell: (Get-Acl -PATH '\Program Files (x86)').Access.IdentityReference.Value
  register: program_filesx86_minimum_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-40177

- name: "MEDIUM | V-40177 | PATCH | Permissions for program file directories must conform to minimum requirements."
  win_acl_inheritance:
     path: '{{ item }}'
     state: 'absent'
  with_items:
      - '\Program Files'
      - '\Program Files (x86)'
  tags:
      - cat2
      - medium
      - patch
      - V-40177

# Remove ACLs for users/groups not listed in STIG
- name: "MEDIUM | V-40177 | PATCH | Permissions for program file directories must conform to minimum requirements."
  win_acl:
     path: '\Program Files'
     user: '{{ item[0] | replace("APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES" , "ALL APPLICATION PACKAGES")}}'
     rights: 'AppendData,ChangePermissions,Delete,DeleteSubdirectoriesAndFiles,ExecuteFile,FullControl,ListDirectory,Modify,Read,ReadAndExecute,ReadAttributes,ReadData,ReadExtendedAttributes,ReadPermissions,Synchronize,TakeOwnership,Traverse,Write,WriteAttributes,WriteData,WriteExtendedAttributes'
     type: '{{ item[1] }}'
     state: 'absent'
  when: "'TrustedInstaller' not in item[0] and 'SYSTEM' not in item[0] and 'Administrators' not in item[0] and 'Users' not in item[0] and 'CREATOR OWNER' not in item[0] or 'allow' not in item[1]"
  with_nested:
      - '{{ program_files_minimum_audit.stdout_lines }}'
      - [ allow, deny ]
  tags:
      - cat2
      - medium
      - patch
      - V-40177

# Remove ACLs for users/groups not listed in STIG
- name: "MEDIUM | V-40177 | PATCH | Permissions for program file directories must conform to minimum requirements."
  win_acl:
     path: '\Program Files (x86)'
     user: '{{ item[0] | replace("APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES" , "ALL APPLICATION PACKAGES")}}'
     rights: 'AppendData,ChangePermissions,Delete,DeleteSubdirectoriesAndFiles,ExecuteFile,FullControl,ListDirectory,Modify,Read,ReadAndExecute,ReadAttributes,ReadData,ReadExtendedAttributes,ReadPermissions,Synchronize,TakeOwnership,Traverse,Write,WriteAttributes,WriteData,WriteExtendedAttributes'
     type: '{{ item[1] }}'
     state: 'absent'
  when: "'TrustedInstaller' not in item[0] and 'SYSTEM' not in item[0] and 'Administrators' not in item[0] and 'Users' not in item[0] and 'CREATOR OWNER' not in item[0] or 'allow' not in item[1]"
  with_nested:
      - '{{ program_filesx86_minimum_audit.stdout_lines }}'
      - [ allow, deny ]
  tags:
      - cat2
      - medium
      - patch
      - V-40177

- name: "MEDIUM | V-40177 | PATCH | Permissions for program file directories must conform to minimum requirements."
  win_acl:
     path: '{{ item }}'
     user: 'NT SERVICE\TrustedInstaller'
     rights: 'FullControl'
     type: 'allow'
     state: 'present'
     inherit: 'ContainerInherit'
     propagation: 'InheritOnly'
  with_items:
      - '\Program Files'
      - '\Program Files (x86)'
  tags:
      - cat2
      - medium
      - patch
      - V-40177

- name: "MEDIUM | V-40177 | PATCH | Permissions for program file directories must conform to minimum requirements."
  win_acl:
     path: '{{ item[0] }}'
     user: '{{ item[1] }}'
     rights: 'Modify'
     type: 'allow'
     state: 'present'
     inherit: 'None'
     propagation: 'None'
  with_nested:
      - ['\Program Files', '\Program Files (x86)']
      - [NT AUTHORITY\SYSTEM, BUILTIN\Administrators]
  tags:
      - cat2
      - medium
      - patch
      - V-40177

- name: "MEDIUM | V-40177 | PATCH | Permissions for program file directories must conform to minimum requirements."
  win_acl:
     path: '{{ item[0] }}'
     user: '{{ item[1] }}'
     rights: 'ReadAndExecute'
     type: 'allow'
     state: 'present'
     inherit: 'ContainerInherit, ObjectInherit'
     propagation: 'None'
  with_nested:
      - ['\Program Files', '\Program Files (x86)']
      - [BUILTIN\Users, ALL APPLICATION PACKAGES]
  tags:
      - cat2
      - medium
      - patch
      - V-40177

- name: "MEDIUM | V-40178 | AUDIT | Permissions for system drive root directory must conform to minimum requirements."
  win_shell: Get-Acl -PATH 'C:' | Format-List
  register: root_permissions_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-40178

- name: "MEDIUM | V-40178 | PATCH | Permissions for system drive root directory must conform to minimum requirements."
  win_acl_inheritance:
     path: 'C:\'
     state: 'absent'
  tags:
      - cat2
      - medium
      - patch
      - V-40178

# Remove ACLs for users/groups not listed in STIG
- name: "MEDIUM | V-40178 | PATCH | Permissions for system drive root directory must conform to minimum requirements."
  win_acl:
     path: 'C:\'
     user: '{{ item[0] }}'
     rights: 'AppendData,ChangePermissions,Delete,DeleteSubdirectoriesAndFiles,ExecuteFile,FullControl,ListDirectory,Modify,Read,ReadAndExecute,ReadAttributes,ReadData,ReadExtendedAttributes,ReadPermissions,Synchronize,TakeOwnership,Traverse,Write,WriteAttributes,WriteData,WriteExtendedAttributes'
     type: '{{ item[1] }}'
     state: 'absent'
  when: "'SYSTEM' not in item[0] and 'Administrators' not in item[0] and 'Users' not in item[0] and 'CREATOR OWNER' not in item[0] or 'allow' not in item[1]"
  with_nested:
      - '{{ root_permissions_audit.stdout_lines }}'
      - [ allow, deny ]
  tags:
      - cat2
      - mediu
      - patch
      - V-40178

- name: "MEDIUM | V-40178 | PATCH | Permissions for system drive root directory must conform to minimum requirements."
  win_acl:
     path: 'C:\'
     user: '{{ item }}'
     rights: 'FullControl'
     type: 'allow'
     state: 'present'
     inherit: 'ContainerInherit, ObjectInherit'
     propagation: 'None'
  with_items:
      - NT AUTHORITY\SYSTEM
      - BUILTIN\Administrators
  tags:
      - cat2
      - medium
      - patch
      - V-40178

- name: "MEDIUM | V-40178 | PATCH | Permissions for system drive root directory must conform to minimum requirements."
  win_acl:
     path: 'C:\'
     user: 'BUILTIN\Users'
     rights: '{{ item.rights }}'
     type: 'allow'
     state: 'present'
     inherit: '{{ item.inherit }}'
     propagation: '{{ item.propagation }}'
  with_items:
      - rights: 'ReadAndExecute'
        inherit: 'ContainerInherit, ObjectInherit'
        propagation: 'None'
      - rights: 'AppendData'
        inherit: 'ContainerInherit'
        propagation: 'None'
  tags:
      - cat2
      - medium
      - patch
      - V-40178

- name: "MEDIUM | V-40178 | PATCH | Permissions for system drive root directory must conform to minimum requirements."
  win_acl:
     path: 'C:\'
     user: 'CREATOR OWNER'
     rights: 'FullControl'
     type: 'allow'
     state: 'present'
     inherit: 'ContainerInherit, ObjectInherit'
     propagation: 'InheritOnly'
  tags:
      - cat2
      - medium
      - patch
      - V-40178

- name: "MEDIUM | V-40200 | AUDIT | The system must be configured to audit Object Access - Central Access Policy Staging failures."
  win_shell: "AuditPol /get /category:*"
  register: central_access_failure_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-40200

- name: "MEDIUM | V-40200 | PATCH | The system must be configured to audit Object Access - Central Access Policy Staging failures."
  win_shell: AuditPol /set /subcategory:"Central Policy Staging" /failure:enable
  tags:
      - cat2
      - medium
      - patch
      - V-40200

- name: "MEDIUM | V-40202 | AUDIT | The system must be configured to audit Object Access - Central Access Policy Staging successes."
  win_shell: "AuditPol /get /category:*"
  register: central_access_success_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-40202

- name: "MEDIUM | V-40202 | PATCH | The system must be configured to audit Object Access - Central Access Policy Staging successes."
  win_shell: AuditPol /set /subcategory:"Central Policy Staging" /success:enable
  tags:
      - cat2
      - medium
      - patch
      - V-40202                

- name: "MEDIUM | V-40204 | AUDIT | Only the default client printer must be redirected to the Remote Desktop Session Host.  (Remote Desktop Services Role)."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v RedirectOnlyDefaultClientPrinter
  register: default_printer_rds_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in default_printer_rds_audit.stderr and default_printer_rds_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-40204

- name: "MEDIUM | V-40204 | PATCH | Only the default client printer must be redirected to the Remote Desktop Session Host.  (Remote Desktop Services Role)."
  win_regedit:
     key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services\'
     value: RedirectOnlyDefaultClientPrinter
     data: 1
     datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-40204

- name: "MEDIUM | V-43238 | AUDIT | The display of slide shows on the lock screen must be disabled (Windows 2012 R2)."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Personalization\ /v NoLockScreenSlideshow
  register: display_lock_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in display_lock_audit.stderr and display_lock_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-43238

- name: "MEDIUM | V-43238 | PATCH | The display of slide shows on the lock screen must be disabled (Windows 2012 R2)."
  win_regedit:
     key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization\'
     value: NoLockScreenSlideshow
     data: 1
     datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-43238

- name: "MEDIUM | V-43239 | AUDIT | Command line data must be prevented from inclusion in process creation events (Windows 2012 R2)."
  win_command: reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit\ /v ProcessCreationIncludeCmdLine_Enabled
  register: prevented_process_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in prevented_process_audit.stderr and prevented_process_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-43239

- name: "MEDIUM | V-43239 | PATCH | Command line data must be prevented from inclusion in process creation events (Windows 2012 R2)."
  win_regedit:
     key: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit\'
     value: ProcessCreationIncludeCmdLine_Enabled
     data: 0
     datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-43239

- name: "MEDIUM | V-43240 | AUDIT | The network selection user interface (UI) must not be displayed on the logon screen (Windows 2012 R2)." 
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\System\ /v DontDisplayNetworkSelectionUI 
  register: network_selection_audit 
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in network_selection_audit.stderr and network_selection_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-43240

- name: "MEDIUM | V-43240 | PATCH | The network selection user interface (UI) must not be displayed on the logon screen (Windows 2012 R2)."
  win_regedit:
     key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\System\'
     value: DontDisplayNetworkSelectionUI
     data: 1
     datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-43240

- name: "MEDIUM | V-43245 | AUDIT | Automatically signing in the last interactive user after a system-initiated restart must be disabled (Windows 2012 R2)."
  win_command: reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\ /v DisableAutomaticRestartSignOn
  register: automatic_restart_signin_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in automatic_restart_signin_audit.stderr and automatic_restart_signin_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-43245

- name: "MEDIUM | V-43245 | PATCH | Automatically signing in the last interactive user after a system-initiated restart must be disabled (Windows 2012 R2)."
  win_regedit:
     key: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\'
     value: DontDisplayNetworkSelectionUI
     data: 1
     datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-43245

- name: "MEDIUM | V-43238 | AUDIT | The display of slide shows on the lock screen must be disabled (Windows 2012 R2)."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Personalization\ /v NoLockScreenSlideshow
  register: display_lock_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in display_lock_audit.stderr and display_lock_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-43238

- name: "MEDIUM | V-43238 | PATCH | The display of slide shows on the lock screen must be disabled (Windows 2012 R2)."
  win_regedit:
     key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization\'
     value: NoLockScreenSlideshow
     data: 1
     datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-43238

- name: "MEDIUM | V-56511 | AUDIT | The Windows Error Reporting Service must be running and configured to start automatically."
  win_shell: Get-Service -name WerSvc
  register: WER_service_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-56511

- name: "MEDIUM | V-56511 | PATCH | The Windows Error Reporting Service must be running and configured to start automatically."
  win_service: 
      name: WerSvc
      start_mode: auto
      state: started
  tags:
      - cat2
      - medium
      - patch
      - V-56511

- name: "MEDIUM | V-57453 | AUDIT | The system must be configured to collect multiple error reports of the same event type."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v BypassDataThrottling
  register: multiple_error_reports_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in multiple_error_reports_audit.stderr and multiple_error_reports_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57453

- name: "MEDIUM | V-57453 | PATCH | The system must be configured to collect multiple error reports of the same event type."
  win_regedit:
     key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\'
     value: BypassDataThrottling
     data: 1
     datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57453

- name: "MEDIUM | V-57455 | AUDIT | The system must be configured to prevent the display of error messages to the user."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v DontShowUI
  register: error_message_audit
  check_mode: no
  changed_when: no
  failed_when: "error_message_audit.stderr and reg_not_found not in error_message_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57455

- name: "MEDIUM | V-57455 | PATCH | The system must be configured to prevent the display of error messages to the user."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: DontShowUI
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57455

- name: "MEDIUM | V-57457 | AUDIT | The system must be configured to store error reports locally, on the system or in the enclave, and not send them to Microsoft."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v CorporateWerServer
  register: error_message_audit
  check_mode: no
  changed_when: no
  failed_when: "error_message_audit.stderr and reg_not_found not in error_message_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57457

# Only make the data " " if there isn't a value. Existing values should be error reporting server hostname or IP.
- name: "MEDIUM | V-57457 | PATCH | The system must be configured to store error reports locally, on the system or in the enclave, and not send them to Microsoft."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: CorporateWerServer
      data: " "
  when: not error_message_audit.stdout
  tags:
      - cat2
      - medium
      - patch
      - V-57457

# Need to recheck if WER is being used first. Skip the rest if WER is not configured.
- name: "MEDIUM | V-57459 | AUDIT | The system must be configured to use SSL to forward error reports."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v CorporateWerServer
  register: error_message_audit
  check_mode: no
  changed_when: no
  failed_when: "error_message_audit.stderr and reg_not_found not in error_message_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57459

# Only run when WER server isn't blank
- name: "MEDIUM | V-57459 | PATCH | The system must be configured to use SSL to forward error reports."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: CorporateWerUseSSL
      data: 1
      datatype: dword
  when: "'CorporateWerServer    REG_SZ     \\r' not in error_message_audit.stdout and reg_not_found not in error_message_audit.stderr"
  tags:
      - cat2
      - medium
      - patch
      - V-57459

# Need to recheck if WER is being used first. Skip the rest if WER is not configured.
- name: "MEDIUM | V-57461 | AUDIT | The system must be configured to send error reports on TCP port 1232."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v CorporateWerServer
  register: error_message_audit
  check_mode: no
  changed_when: no
  failed_when: "error_message_audit.stderr and reg_not_found not in error_message_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57461

# Only run when WER server isn't blank
- name: "MEDIUM | V-57461 | AUDIT | The system must be configured to send error reports on TCP port 1232."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v CorporateWerPortNumber
  register: error_message_port_audit
  check_mode: no
  changed_when: no
  failed_when: "error_message_port_audit.stderr and reg_not_found not in error_message_port_audit.stderr"
  when: "'CorporateWerServer    REG_SZ     \\r' not in error_message_audit.stdout and reg_not_found not in error_message_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57461

# Only run when WER server isn't blank
- name: "MEDIUM | V-57461 | PATCH | The system must be configured to send error reports on TCP port 1232."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: CorporateWerPortNumber
      data: 0x000004d0
      datatype: dword
  when: "'CorporateWerServer    REG_SZ     \\r' not in error_message_audit.stdout and reg_not_found not in error_message_audit.stderr"
  tags:
      - cat2
      - medium
      - patch
      - V-57461

- name: "MEDIUM | V-57463 | AUDIT | The system must be configured to archive error reports."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v DisableArchive
  register: disable_archive_audit
  check_mode: no
  changed_when: no
  failed_when: "disable_archive_audit.stderr and reg_not_found not in disable_archive_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57463

- name: "MEDIUM | V-57463 | PATCH | The system must be configured to archive error reports."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: DisableArchive
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57463

- name: "MEDIUM | V-57465 | AUDIT | The system must be configured to store all data in the error report archive."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v ConfigureArchive
  register: archive_error_reports_audit
  check_mode: no
  changed_when: no
  failed_when: "archive_error_reports_audit.stderr and reg_not_found not in archive_error_reports_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57465

- name: "MEDIUM | V-57465 | PATCH | The system must be configured to store all data in the error report archive."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: ConfigureArchive
      data: 0x00000002
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57465

- name: "MEDIUM | V-57467 | AUDIT | The maximum number of error reports to archive on a system must be configured to 100 or greater."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v MaxArchiveCount
  register: max_achive_count_audit
  check_mode: no
  changed_when: no
  failed_when: "max_achive_count_audit.stderr and reg_not_found not in max_achive_count_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57467

- name: "MEDIUM | V-57467 | PATCH | The maximum number of error reports to archive on a system must be configured to 100 or greater."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: MaxArchiveCount
      data: 0x00000064
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57467

- name: "MEDIUM | V-57469 | AUDIT | The system must be configured to queue error reports until a local or DOD-wide collector is available."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v DisableQueue
  register: disable_queue_audit
  check_mode: no
  changed_when: no
  failed_when: "disable_queue_audit.stderr and reg_not_found not in disable_queue_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57469

- name: "MEDIUM | V-57469 | PATCH | The system must be configured to queue error reports until a local or DOD-wide collector is available."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: DisableQueue
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57469

- name: "MEDIUM | V-57471 | AUDIT | The system must be configured to add all error reports to the queue."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v ForceQueue
  register: force_queue_audit
  check_mode: no
  changed_when: no
  failed_when: "force_queue_audit.stderr and reg_not_found not in force_queue_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57471

- name: "MEDIUM | V-57471 | PATCH | The system must be configured to add all error reports to the queue."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: ForceQueue
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57471

- name: "MEDIUM | V-57473 | AUDIT | The maximum number of error reports to queue on a system must be configured to 50 or greater."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v MaxQueueCount
  register: max_queue_audit
  check_mode: no
  changed_when: no
  failed_when: "max_queue_audit.stderr and reg_not_found not in max_queue_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57473

- name: "MEDIUM | V-57473 | PATCH | The maximum number of error reports to queue on a system must be configured to 50 or greater."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: MaxQueueCount
      data: 0x00000032
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57473

- name: "MEDIUM | V-57475 | AUDIT | The system must be configured to attempt to forward queued error reports once a day."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v QueuePesterInterval
  register: daily_forward_audit
  check_mode: no
  changed_when: no
  failed_when: "daily_forward_audit.stderr and reg_not_found not in daily_forward_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57475

- name: "MEDIUM | V-57475 | PATCH | The system must be configured to attempt to forward queued error reports once a day."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: QueuePesterInterval
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57475

- name: "MEDIUM | V-57477 | AUDIT | The system must be configured to automatically consent to send all data requested by a local or DOD-wide error collection site."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\Consent\" /v DefaultConsent
  register: default_consent_audit
  check_mode: no
  changed_when: no
  failed_when: "default_consent_audit.stderr and reg_not_found not in default_consent_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57477

- name: "MEDIUM | V-57477 | PATCH | The system must be configured to automatically consent to send all data requested by a local or DOD-wide error collection site."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\Consent'
      value: DefaultConsent
      data: 0x00000004
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57477

- name: "MEDIUM | V-57479 | AUDIT | The system must be configured to permit the default consent levels of Windows Error Reporting to override any other consent policy setting."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\Consent\" /v DefaultOverrideBehavior
  register: override_audit
  check_mode: no
  changed_when: no
  failed_when: "override_audit.stderr and reg_not_found not in override_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57479

- name: "MEDIUM | V-57479 | PATCH | The system must be configured to permit the default consent levels of Windows Error Reporting to override any other consent policy setting."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\Consent'
      value: DefaultOverrideBehavior
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57479

- name: "MEDIUM | V-57633 | AUDIT | The system must be configured to audit Policy Change - Authorization Policy Change successes."
  win_shell: "AuditPol /get /category:*"
  register: auth_policy_successes_audit
  check_mode: no
  changed_when: no
  ignore_errors: yes
  tags:
      - cat2
      - medium
      - audit
      - V-57633

- name: "MEDIUM | V-57633 | PATCH | The system must be configured to audit Policy Change - Authorization Policy Change successes."
  win_shell: AuditPol /set /subcategory:"Authorization Policy Change" /success:enable
  tags:
      - cat2
      - medium
      - patch
      - V-57633

- name: "MEDIUM | V-57635 | AUDIT | The system must be configured to audit Policy Change - Authorization Policy Change failures."
  win_shell: "AuditPol /get /category:*"
  register: auth_policy_failures_audit
  check_mode: no
  changed_when: no
  ignore_errors: yes
  tags:
      - cat2
      - medium
      - audit
      - V-57635

- name: "MEDIUM | V-57635 | PATCH | The system must be configured to audit Policy Change - Authorization Policy Change failures."
  win_shell: AuditPol /set /subcategory:"Central Policy Staging" /failure:enable
  tags:
      - cat2
      - medium
      - patch
      - V-57635

- name: "MEDIUM | V-57639 | AUDIT | Users must be required to enter a password to access private keys stored on the computer."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Cryptography\ /v ForceKeyProtection
  register: password_private_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in password_private_audit.stderr and password_private_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57639

- name: "MEDIUM | V-57639 | PATCH | Users must be required to enter a password to access private keys stored on the computer."
  win_regedit:
     key: 'HKLM:\SOFTWARE\Policies\Microsoft\Cryptography\'
     value: ForceKeyProtection
     data: 2
     datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57639
