- name: "HIGH | V-1073 | AUDIT | Systems must be maintained at a supported service pack level."
  win_command: reg query \"HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\"
  register: supported_pack_level_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in supported_pack_level_audit.stderr and supported_pack_level_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-1073

- name: "HIGH | V-1073 | PATCH | Systems must be maintained at a supported service pack level."
  action: win_ping
  tags:
      - cat1
      - high
      - patch
      - V-1073

#McAfee is SCIF's antivirus program
- name: "HIGH | V-1074 | AUDIT | An approved DoD antivirus program must be installed and used."
  action: win_ping
  register: mcafee_approved_audit
  check_mode: no
  changed_when: no
  tags:
      - cat1
      - high
      - audit
      - V-1074

#McAfee is SCIF's antivirus program
- name: "HIGH | V-1074 | PATCH | An approved DoD antivirus program must be installed and used."
  action: win_ping
  tags:
      - cat1
      - high
      - patch
      - V-1074

- name: "HIGH | V-1093 | AUDIT | Anonymous enumeration of shares must be restricted."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v RestrictAnonymous
  register: anon_shares_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in anon_shares_audit.stderr and anon_shares_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-1093

- name: "HIGH | V-1093 | PATCH | Anonymous enumeration of shares must be restricted."
  win_regedit: 
    key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
    value: RestrictAnonymous
    data: 1
    datatype: dword
  tags:
      - cat1
      - high
      - patch
      - V-1093

- name: "HIGH | V-1152 | AUDIT | Anonymous access to the registry must be restricted."
  win_command: reg query HKLM\SYSTEM\CurrentControlSet\Control\SecurePipeServers\Winreg
  register: anon_registry_access_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in anon_registry_access_audit.stderr and anon_registry_access_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-1152

# NOTE: V-1152 is shared between all OS's, but Backup Operators data for 2k12 is 'Read' and for 2k8 is 'Special'.
- name: "HIGH | V-1152 | PATCH | Anonymous access to the registry must be restricted."
  win_regedit: 
    key: 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurePipeServers\Winreg'
    value: "{{ item.value }}"
    data: "{{ item.data }}"
  with_items: 
     - { value: 'Administrators', data: 'Full' }
     - { value: 'Backup Operators', data: 'Read' }
     - { value: 'LOCAL SERVICE', data: 'Read' }
  tags:
       - cat1
       - high
       - patch
       - V-1152

- name: "HIGH | V-1153 | AUDIT | The LanMan authentication level must be set to send NTLMv2 response only, and to refuse LM and NTLM."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v LMCompatibilityLevel
  register: lanMan_authentication_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in lanMan_authentication_audit.stderr and lanMan_authentication_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-1153

- name: "HIGH | V-1153 | PATCH | The LanMan authentication level must be set to send NTLMv2 response only, and to refuse LM and NTLM."
  win_regedit:
    key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
    value: LMCompatibilityLevel
    data: 5
    datatype: dword
  tags:
      - cat1
      - high
      - patch
      - V-1153

- name: "HIGH | V-1159 | AUDIT | The Recovery Console option must be set to prevent automatic logon to the system."
  win_command: reg query \"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Setup\RecoveryConsole\" /v SecurityLevel 
  register: recovery_prevent_autologin_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in recovery_prevent_autologin_audit.stderr and recovery_prevent_autologin_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-1159

- name: "HIGH | V-1159 | PATCH | The Recovery Console option must be set to prevent automatic logon to the system."
  win_regedit:
    key: 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Setup\RecoveryConsole\'
    value: SecurityLevel
    data: 0
    datatype: dword
  tags:
      - cat1
      - high
      - patch
      - V-1159

- name: "HIGH | V-2374 | AUDIT | Autoplay must be disabled for all drives."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\policies\Explorer\ /v NoDriveTypeAutoRun /t REG_DWORD /f 25 
  register: autoplay_disabled_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in autoplay_disabled_audit.stderr and autoplay_disabled_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-2374

- name: "HIGH | V-2374 | PATCH | Autoplay must be disabled for all drives."
  action: win_ping
  tags:
      - cat1
      - high
      - patch
      - V-2374


- name: "HIGH | V-3339 | AUDIT | Unauthorized remotely accessible registry paths must not be configured."
  win_command: reg query \"HKLM\System\CurrentControlSet\Control\SecurePipeServers\ winreg\" /v Machine /t REG_MULTI_SZ /f {{ item }}
  register: remotely_accessible_registry_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in remotely_accessible_registry_audit.stderr and remotely_accessible_registry_audit.stderr"
  with_items:
      - System\CurrentControlSet\Control\ProductOptions 
      - \"System\CurrentControlSet\Control\Server Applications\" 
      - \"Software\Microsoft\Windows NT\CurrentVersion\" 
  tags:
      - cat1
      - high
      - audit
      - V-3339

#This may need to be implemented using something other than a registry edit
- name: "HIGH | V-3339 | PATCH | Unauthorized remotely accessible registry paths must not be configured."
  win_regedit:
    key: 'HKLM:\System\CurrentControlSet\Control\SecurePipeServers\ winreg'
    value: Machine
    data: \0System\CurrentControlSet\Control\ProductOptions\0\"System\CurrentControlSet\Control\Server Applications\"\0\"Software\Microsoft\Windows NT\CurrentVersion\"\0\0
    datatype: multistring
  changed_when: no
  tags:
      - cat1
      - high
      - patch
      - V-3339

- name: "HIGH | V-3340 | AUDIT | Network shares that can be accessed anonymously must not be allowed."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanManServer\Parameters\ /v NullSessionShares
  register: network_shares_anonymous_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in network_shares_anonymous_audit.stderr and network_shares_anonymous_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-3340

- name: "HIGH | V-3340 | PATCH | Network shares that can be accessed anonymously must not be allowed."
  action: win_ping
  tags:
      - cat1
      - high
      - patch
      - V-3340

- name: "HIGH | V-3343 | AUDIT | Solicited Remote Assistance must not be allowed."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fAllowToGetHelp /t REG_DWORD /f 0
  register: solicited_remote_assistance_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in solicited_remote_assistance_audit.stderr and solicited_remote_assistance_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-3343

- name: "HIGH | V-3343 | PATCH | Solicited Remote Assistance must not be allowed."
  action: win_ping
  tags:
      - cat1
      - high
      - patch
      - V-3343

- name: "HIGH | V-3344 | AUDIT | Local accounts with blank passwords must be restricted to prevent access from the network."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa\ /v LimitBlankPasswordUse /t REG_DWORD /f 1
  register: blankpass_network_restriction_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in blankpass_network_restriction_audit.stderr and blankpass_network_restriction_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-3344

- name: "HIGH | V-3344 | PATCH | Local accounts with blank passwords must be restricted to prevent access from the network."
  action: win_ping
  tags:
      - cat1
      - high
      - patch
      - V-3344

- name: "HIGH | V-3379 | AUDIT | The system must be configured to prevent the storage of the LAN Manager hash of passwords."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa\ /v NoLMHash /t REG_DWORD /f 1
  register: prevent_lanman_storage_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in prevent_lanman_storage_audit.stderr and prevent_lanman_storage_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-3379

- name: "HIGH | V-3379 | PATCH | The system must be configured to prevent the storage of the LAN Manager hash of passwords."
  action: win_ping
  tags:
      - cat1
      - high
      - patch
      - V-3379

#This is currently TBD but should probably be implemented
- name: "HIGH | V-4443 | AUDIT | Unauthorized remotely accessible registry paths and sub-paths must not be configured."
  win_command: reg query HKLM\System\CurrentControlSet\Control\SecurePipeServers\Winreg\AllowedPaths\ /v Machine /t REG_MULTI_SZ /f {{ item }}
  register: unauthorized_remote_registry_paths_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in unauthorized_remote_registry_paths_audit.stderr and unauthorized_remote_registry_paths_audit.stderr"
  with_items:
      - \"Software\Microsoft\OLAP Server\" 
      - \"Software\Microsoft\Windows NT\CurrentVersion\Perflib\" 
      - \"Software\Microsoft\Windows NT\CurrentVersion\Print\" 
      - \"Software\Microsoft\Windows NT\CurrentVersion\Windows\" 
      - System\CurrentControlSet\Control\ContentIndex 
      - System\CurrentControlSet\Control\Print\Printers 
      - \"System\CurrentControlSet\Control\Terminal Server\" 
      - \"System\CurrentControlSet\Control\Terminal Server\UserConfig\" 
      - \"System\CurrentControlSet\Control\Terminal Server\DefaultUserConfiguration\" 
      - System\CurrentControlSet\Services\Eventlog 
      - System\CurrentControlSet\Services\Sysmonlog 
  tags:
      - cat1
      - high
      - audit
      - V-4443

#This is currently TBD but should probably be implemented
- name: "HIGH | V-4443 | PATCH | Unauthorized remotely accessible registry paths and sub-paths must not be configured."
  action: win_ping
  tags:
      - cat1
      - high
      - patch
      - V-4443

- name: "HIGH | V-6834 | AUDIT | Anonymous access to Named Pipes and Shares must be restricted."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanManServer\Parameters\ /v RestrictNullSessAccess /t REG_DWORD /f 1
  register: anon_access_pipes_shares_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in anon_access_pipes_shares_audit.stderr and anon_access_pipes_shares_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-6834

- name: "HIGH | V-6834 | PATCH | Anonymous access to Named Pipes and Shares must be restricted."
  action: win_ping
  tags:
      - cat1
      - high
      - patch
      - V-6834

- name: "HIGH | V-21973 | AUDIT | Autoplay must be turned off for non-volume devices."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\Explorer\ /v NoAutoplayfornonVolume /t REG_DWORD /f 1
  register: autoplay_nonvolume_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in autoplay_nonvolume_audit.stderr and autoplay_nonvolume_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-21973

- name: "HIGH | V-21973 | PATCH | Autoplay must be turned off for non-volume devices."
  action: win_ping
  tags:
      - cat1
      - high
      - patch

- name: "HIGH | V-22692 | AUDIT | The default Autorun behavior must be configured to prevent Autorun commands."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\ /v NoAutorun /t REG_DWORD /f 1
  register: autorun_prevent_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in autorun_prevent_audit.stderr and autorun_prevent_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-22692

- name: "HIGH | V-22692 | PATCH | The default Autorun behavior must be configured to prevent Autorun commands."
  action: win_ping
  tags:
      - cat1
      - high
      - patch
      - V-22692

#This rule will need to be revisted according to SCIFs user accounts
- name: "HIGH | V-26070 | AUDIT | Standard user accounts must only have Read permissions to the Winlogon registry key."
  win_command: reg query \"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\"
  register: standard_user_read_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in standard_user_read_audit.stderr and standard_user_read_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-26070

#This rule will need to be revisted according to SCIFs user accounts
- name: "HIGH | V-26070 | PATCH | Standard user accounts must only have Read permissions to the Winlogon registry key."
  win_regedit:
      key: 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\'
      value: "{{ item.value }}"
      data: "{{ item.data }}"
  changed_when: no
  with_items:
      - { value: 'TrustedInstaller', data: 'Full Control' }
      - { value: 'SYSTEM', data: 'Full Control' }
      - { value: 'Administrators', data: 'Full Control' }
      - { value: 'Users', data: 'Read' }
      - { value: 'ALL APPLICATION PACKAGES', data: 'Read' }
  tags:
      - cat1
      - high
      - patch
      - V-26070

- name: "HIGH | V-26283 | AUDIT | Anonymous enumeration of SAM accounts must not be allowed."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa\ /v RestrictAnonymousSAM /t REG_DWORD /f 1
  register: anonymous_enum_sam_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in anonymous_enum_sam_audit.stderr and anonymous_enum_sam_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-26283

- name: "HIGH | V-26283 | PATCH | Anonymous enumeration of SAM accounts must not be allowed."
  action: win_ping
  tags:
      - cat1
      - high
      - patch
      - V-26283

#This requires knowledge of SCIF user accounts to complete
#Will likely involve breaking into two separate tasks
#Need a way to evaluate user permissions
- name: "HIGH | V-32282 | AUDIT | Standard user accounts must only have Read permissions to the Active Setup Installed Components registry key."
  win_command: reg query {{ item }}
  register: standard_read_active1_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in standard_read_active1_audit.stderr and standard_read_active1_audit.stderr"
  with_items:
      - \"HKLM\Software\Microsoft\Active Setup\Installed Components\"
      - \"HKLM\Software\Wow6432Node\Microsoft\Active Setup\Installed Components\"
  tags:
      - cat1
      - high
      - audit
      - V-32282

- name: "HIGH | V-32282 | PATCH | Standard user accounts must only have Read permissions to the Active Setup Installed Components registry key."
  action: win_ping
  tags:
      - cat1
      - high
      - patch
      - V-32282

- name: "HIGH | V-34974 | AUDIT | The Windows Installer Always install with elevated privileges option must be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\Installer\ /v AlwaysInstallElevated /t REG_DWORD /f 0
  register: install_elevated_disabled_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in install_elevated_disabled_audit.stderr and install_elevated_disabled_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-34974

- name: "HIGH | V-34974 | PATCH | The Windows Installer Always install with elevated privileges option must be disabled."
  action: win_ping
  tags:
      - cat1
      - high
      - patch
      - V-34974

- name: "HIGH | V-36718 | AUDIT | The Windows Remote Management (WinRM) service must not use Basic authentication."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\WinRM\Service\ /v AllowBasic /t REG_DWORD /f 0
  register: winrm_service_basic_auth_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in winrm_service_basic_auth_audit.stderr and winrm_service_basic_auth_audit.stderr"
  tags:
      - cat1
      - high
      - audit
      - V-36718

- name: "HIGH | V-36718 | PATCH | The Windows Remote Management (WinRM) service must not use Basic authentication."
  action: win_ping
  tags:
      - cat1
      - high
      - patch
      - V-36718
